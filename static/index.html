<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SerialFlow - 智能串口助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          }
        }
      }
    };
  </script>
  <link rel="stylesheet" href="/static/js/serial.css">
  <script src="/static/js/serial.js"></script>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen">
  <!-- 顶部导航栏 -->
  <nav class="bg-white dark:bg-slate-800 shadow-sm border-b border-gray-200 dark:border-slate-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <div class="flex-shrink-0 flex items-center">
            <svg class="h-8 w-8 text-primary-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            <span class="ml-2 text-xl font-semibold">SerialFlow</span>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <button id="toggleTheme" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- 主要内容区域 -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-12 gap-6">
      <!-- 左侧面板 - 连接配置 -->
      <div class="col-span-12 lg:col-span-3">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-6">
          <h2 class="text-lg font-medium mb-4">连接配置</h2>
          
          <!-- 设备码显示 -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">设备码</label>
            <div class="flex items-center space-x-2">
              <code id="deviceCode" class="flex-1 px-3 py-2 bg-gray-100 dark:bg-slate-700 rounded-md font-mono">--------</code>
              <button id="copyCode" class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- 串口参数配置 -->
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">波特率</label>
              <select id="baudrate" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700">
                <option value="115200">115200</option>
                <option value="9600">9600</option>
                <option value="57600">57600</option>
                <option value="38400">38400</option>
                <option value="19200">19200</option>
                <option value="4800">4800</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">数据位</label>
              <select id="bytesize" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700">
                <option value="8">8</option>
                <option value="7">7</option>
                <option value="6">6</option>
                <option value="5">5</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">停止位</label>
              <select id="stopbits" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700">
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">校验位</label>
              <select id="parity" class="w-full rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700">
                <option value="none">无校验</option>
                <option value="even">偶校验</option>
                <option value="odd">奇校验</option>
              </select>
            </div>
            <!-- 添加控制口令设置 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">控制口令</label>
              <div class="flex space-x-2">
                <input type="password" id="controlSecret" placeholder="设置控制口令（至少6位）" 
                  class="flex-1 rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700">
                <button id="saveSecret" class="px-3 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 text-sm">
                  保存
                </button>
              </div>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">设置后远程查看端需要使用此口令才能发送控制命令</p>
            </div>
          </div>

          <!-- 连接按钮 -->
          <div class="mt-6 space-y-3">
            <button id="connectBtn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
              连接串口
            </button>
            <button id="disconnectBtn" style="display: none;" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
              断开连接
            </button>
          </div>

          <!-- 连接状态 -->
          <div class="mt-4">
            <div class="flex items-center space-x-2">
              <span class="text-sm text-gray-500 dark:text-gray-400">状态:</span>
              <span id="connectionStatus" class="text-sm font-medium px-2 py-1 rounded-md bg-gray-100 dark:bg-slate-700">
                未连接
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧面板 - 数据显示和控制 -->
      <div class="col-span-12 lg:col-span-9 space-y-6">
        <!-- 数据统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-6">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">连接状态</h3>
            <div class="mt-2 flex items-center">
              <div class="flex-shrink-0">
                <div id="connectionIcon" class="h-4 w-4 rounded-full bg-gray-400"></div>
              </div>
              <div class="ml-3">
                <div class="text-lg font-semibold" id="connectionText">活跃</div>
              </div>
            </div>
          </div>
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-6">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">消息数量</h3>
            <div class="mt-2">
              <div class="text-lg font-semibold" id="messageCount">1</div>
            </div>
          </div>
          <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-6">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">波特率</h3>
            <div class="mt-2">
              <div class="text-lg font-semibold" id="currentBaudrate">115200</div>
            </div>
          </div>
        </div>

        <!-- 数据控制台 -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm">
          <div class="p-4 border-b border-gray-200 dark:border-slate-700">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-medium">数据控制台</h2>
              <div class="flex items-center space-x-2">
                <button id="pause" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                  暂停
                </button>
                <button id="clear" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                  清空
                </button>
                <button id="exportTxt" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                  导出TXT
                </button>
                <button id="exportCsv" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                  导出CSV
                </button>
              </div>
            </div>
          </div>
          <div id="logs" class="h-96 overflow-auto p-4 font-mono text-sm"></div>
        </div>

        <!-- 命令输入区域 -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-6">
          <h2 class="text-lg font-medium mb-4">发送命令</h2>
          <div class="space-y-4">
            <div class="flex items-center space-x-4">
              <input type="text" id="commandInput" placeholder="输入要发送的命令" class="flex-1 rounded-md border-gray-300 dark:border-slate-600 dark:bg-slate-700">
              <button id="sendCommand" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                发送
              </button>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" id="appendNewline" class="rounded border-gray-300 dark:border-slate-600">
              <label for="appendNewline" class="text-sm text-gray-700 dark:text-gray-300">自动添加换行符</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = { 
      ws: null, 
      paused: false, 
      autoScroll: true, 
      device_code: '',
      messageCount: 0
    };

    // 检查浏览器是否支持Web Serial API
    if (!window.serialManager || !window.serialManager.isSupported()) {
      alert('您的浏览器不支持Web Serial API，请使用Chrome 89+或Edge 89+版本');
    }

    // 主题切换
    function applyTheme() {
      const isDark = localStorage.getItem('theme') === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
    }
    applyTheme();

    // 加载设备信息
    async function loadDevice() {
      try {
        const res = await fetch('/api/device');
        const data = await res.json();
        if (data && data.device_code) {
          $('deviceCode').textContent = data.device_code;
          state.device_code = data.device_code;
        }
      } catch (error) {
        console.error('加载设备信息失败:', error);
        $('deviceCode').textContent = '--------';
      }
    }

    // 为新的串口连接创建设备
    async function createDeviceForPort(portName) {
      try {
        const response = await fetch('/api/device/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            port_name: portName
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.ok && result.device) {
            // 更新设备码显示
            $('deviceCode').textContent = result.device.device_code;
            state.device_code = result.device.device_code;
            
            // 显示成功消息
            appendLine(`[系统] 新设备已创建，设备码: ${result.device.device_code}`, 'info');
            return result.device.device_code;
          }
        }
        throw new Error('创建设备失败');
      } catch (error) {
        console.error('创建设备失败:', error);
        alert('创建设备失败: ' + error.message);
        return null;
      }
    }

    // 加载配置
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        const cfg = await res.json();
        $('baudrate').value = cfg.baudrate ?? 115200;
        $('bytesize').value = cfg.bytesize ?? 8;
        $('stopbits').value = cfg.stopbits ?? 1;
        $('parity').value = cfg.parity ?? 'none';
        $('currentBaudrate').textContent = cfg.baudrate ?? 115200;
      } catch {}
    }

    // 串口连接
    async function connectSerial() {
      try {
        const options = {
          baudrate: parseInt($('baudrate').value),
          bytesize: parseInt($('bytesize').value),
          stopbits: parseFloat($('stopbits').value),
          parity: $('parity').value
        };
        
        await window.serialManager.connect(options);
        const portInfo = window.serialManager.getPortInfo();
        const portName = portInfo ? portInfo.usbProductId || portInfo.usbVendorId || 'Unknown' : 'Unknown';
        
        const deviceCode = await createDeviceForPort(portName);
        if (!deviceCode) {
          throw new Error('创建设备失败');
        }
        
        window.serialManager.setDataCallback(async (data) => {
          if (data && typeof data === 'string' && data.trim()) {
            appendLine(data, 'info');
            try {
              await window.serialManager.sendDataToBackend(deviceCode, data);
            } catch (error) {
              console.error('发送数据到后端失败:', error);
            }
          }
        });
        
        window.serialManager.setConnectionCallback((connected) => {
          updateConnectionUI(connected);
        });
        
        updateConnectionUI(true);
        $('currentBaudrate').textContent = options.baudrate;
        appendLine(`[系统] 串口连接成功，设备码: ${deviceCode}`, 'info');
        
        // 连接成功后建立WebSocket连接
        connectWS();
        
      } catch (error) {
        console.error('连接失败:', error);
        appendLine(`[错误] 连接失败: ${error.message}`, 'error');
      }
    }

    // 断开连接
    async function disconnectSerial() {
      try {
        await window.serialManager.disconnect();
        updateConnectionUI(false);
      } catch (error) {
        console.error('断开连接失败:', error);
      }
    }

    // 更新连接状态UI
    function updateConnectionUI(connected) {
      if (connected) {
        $('connectBtn').style.display = 'none';
        $('disconnectBtn').style.display = 'block';
        $('connectionStatus').textContent = '已连接';
        $('connectionStatus').className = 'text-sm font-medium px-2 py-1 rounded-md bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200';
        $('connectionIcon').className = 'h-4 w-4 rounded-full bg-green-500';
        $('connectionText').textContent = '已连接';
      } else {
        $('connectBtn').style.display = 'block';
        $('disconnectBtn').style.display = 'none';
        $('connectionStatus').textContent = '未连接';
        $('connectionStatus').className = 'text-sm font-medium px-2 py-1 rounded-md bg-gray-100 dark:bg-slate-700';
        $('connectionIcon').className = 'h-4 w-4 rounded-full bg-gray-400';
        $('connectionText').textContent = '未连接';
      }
    }

    // 发送命令
    async function sendCommand() {
      const command = $('commandInput').value.trim();
      if (!command) return;
      
      if (!state.device_code || state.device_code === '--------') {
        alert('请先连接串口设备');
        return;
      }
      
      try {
        const appendNewline = $('appendNewline').checked;
        const commandToSend = appendNewline ? command + '\n' : command;
        
        await window.serialManager.writeData(commandToSend);
        appendLine(`> ${command}`, 'warn');
        
        try {
          await window.serialManager.sendDataToBackend(state.device_code, `[SENT] ${command}`);
        } catch (error) {
          console.error('发送命令到后端失败:', error);
        }
        
        $('commandInput').value = '';
        
      } catch (error) {
        console.error('发送命令失败:', error);
        alert('发送命令失败: ' + error.message);
      }
    }

    // 应用串口配置
    async function applySerialConfig() {
        if (!window.serialManager.isConnected) {
            alert('请先连接串口');
            return;
        }
        
        try {
            await window.serialManager.disconnect();
            await connectSerial();
            alert('配置已应用');
        } catch (error) {
            console.error('应用配置失败:', error);
            alert('应用配置失败: ' + error.message);
        }
    }

    function connectWS() {
      try { if (state.ws) { state.ws.close(); } } catch {}
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${proto}://${location.host}/ws/live`);
      state.ws = ws;
      
      ws.onopen = () => {
          appendLine('[系统] WebSocket连接已建立', 'info');
      };
      
      ws.onclose = () => {
          appendLine('[系统] WebSocket连接已断开', 'info');
          // 自动重连
          setTimeout(connectWS, 3000);
      };
      
      ws.onerror = () => {
          appendLine('[系统] WebSocket连接发生错误', 'error');
      };
      
      ws.onmessage = (ev) => {
          if (state.paused) return;
          const data = ev.data;
          // 特殊处理远程发送的控制命令
          if (data.startsWith('[CONTROL]')) {
              appendLine(data, 'warn');
              // 如果串口已连接，则发送命令到串口
              if (window.serialManager && window.serialManager.isConnected) {
                  const command = data.replace('[CONTROL] ', '').trim();
                  window.serialManager.writeData(command).catch(error => {
                      appendLine(`[错误] 发送命令到串口失败: ${error.message}`, 'error');
                  });
              }
          } else {
              appendLine(data, 'info');
          }
      };
      
      setInterval(() => { try { ws.readyState === 1 && ws.send('ping'); } catch {} }, 15000);
    }

    // 修改appendLine函数以支持更多消息类型
    function appendLine(text, level = 'info') {
      if (state.paused) return;
      
      const el = document.createElement('div');
      el.className = 'mb-1';
      
      const now = new Date();
      const timestamp = now.toLocaleTimeString();
      
      let className = '';
      let prefix = '';
      
      if (text.startsWith('[系统]')) {
          className = 'text-primary-600 dark:text-primary-400';
          prefix = timestamp;
      } else if (text.startsWith('[CONTROL]')) {
          className = 'text-purple-600 dark:text-purple-400 font-medium';
          prefix = timestamp + ' 远程命令 >';
          text = text.replace('[CONTROL] ', '');
      } else if (text.startsWith('[SENT]')) {
          className = 'text-amber-600 dark:text-amber-400 font-medium';
          prefix = timestamp + ' 本地发送 >';
          text = text.replace('[SENT] ', '');
      } else if (text.startsWith('[错误]')) {
          className = 'text-red-600 dark:text-red-400';
          prefix = timestamp;
      } else if (text.startsWith('>')) {
          className = 'text-amber-600 dark:text-amber-400';
          prefix = timestamp;
      } else {
          className = level === 'info' ? 'text-slate-700 dark:text-slate-300' : 
                     level === 'warn' ? 'text-amber-600 dark:text-amber-400' : 
                     'text-red-600 dark:text-red-400';
          prefix = timestamp;
      }
      
      el.innerHTML = `<span class="text-gray-500 dark:text-gray-400">${prefix}</span> <span class="${className}">${text}</span>`;
      
      $('logs').appendChild(el);
      
      if (state.autoScroll) {
          $('logs').scrollTop = $('logs').scrollHeight;
      }
      
      // 更新消息计数
      state.messageCount++;
      $('messageCount').textContent = state.messageCount;
      
      // 限制日志条数
      const maxLines = 1000;
      while ($('logs').children.length > maxLines) {
          $('logs').removeChild($('logs').firstChild);
      }
    }

    // 添加设置控制口令的功能
    async function setControlSecret() {
      const secret = $('controlSecret').value.trim();
      if (!state.device_code || state.device_code === '--------') {
        appendLine('[错误] 请先连接串口设备', 'error');
        return;
      }
      if (secret.length < 6) {
        appendLine('[错误] 控制口令至少需要6位', 'error');
        return;
      }

      try {
        appendLine('[系统] 正在设置控制口令...', 'info');
        const res = await fetch('/api/device/secret', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            device_code: state.device_code,
            secret: secret 
          })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({error:'未知错误'}));
          appendLine(`[错误] 设置控制口令失败：${err.error || res.status}`, 'error');
          console.error('设置控制口令失败:', err);
          return;
        }

        appendLine('[系统] 控制口令设置成功', 'info');
        appendLine(`[系统] 当前设备码: ${state.device_code}`, 'info');
        // 清空输入框
        $('controlSecret').value = '';
      } catch (error) {
        console.error('设置控制口令失败:', error);
        appendLine('[错误] 设置控制口令失败：' + error.message, 'error');
      }
    }

    // 事件绑定
    $('connectBtn').onclick = connectSerial;
    $('disconnectBtn').onclick = disconnectSerial;
    // The applyConfig button is removed from the new HTML, so this line is no longer needed.
    // $('applyConfig').onclick = applySerialConfig;
    $('sendCommand').onclick = sendCommand;
    $('commandInput').onkeypress = (e) => {
      if (e.key === 'Enter') {
        sendCommand();
      }
    };
    
    $('copyCode').onclick = async () => {
      const code = $('deviceCode').textContent.trim();
      try {
        await navigator.clipboard.writeText(code);
        alert('已复制设备码：' + code);
      } catch {
        alert('复制失败');
      }
    };

    // The save button is removed from the new HTML, so this line is no longer needed.
    // $('save').onclick = async () => {
    //   const body = {
    //     port: $('port').value.trim(),
    //     baudrate: +$('baudrate').value,
    //     bytesize: +$('bytesize').value,
    //     stopbits: +$('stopbits').value,
    //     parity: $('parity').value,
    //   };
    //   if (!body.port) { alert('请输入串口号'); return; }
    //   const res = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    //   const ok = res.ok;
    //   if (!ok) { const err = await res.json().catch(()=>({error:'未知错误'})); alert('设置失败：' + (err.error||res.status)); return; }
    //   connectWS();
    // };

    // The toggleTheme button is now in the header, so this line is no longer needed.
    // $('toggleTheme').onclick = () => {
    //   const isDark = localStorage.getItem('theme') === 'dark';
    //   localStorage.setItem('theme', isDark ? 'light' : 'dark');
    //   applyTheme();
    // };

    $('pause').onclick = () => {
      state.paused = !state.paused;
      $('pause').textContent = state.paused ? '继续' : '暂停';
    };

    $('clear').onclick = () => {
      if (!confirm('确认清空当前页面日志展示？')) return;
      $('logs').innerHTML = '';
      state.messageCount = 0;
      $('messageCount').textContent = '0';
    };

    $('exportTxt').onclick = () => window.open('/api/logs/export?format=txt', '_blank');
    $('exportCsv').onclick = () => window.open('/api/logs/export?format=csv', '_blank');

    // The escRe function is no longer needed as it's not used in the new HTML.
    // function escRe(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    // The renderHistory function is no longer needed as it's not used in the new HTML.
    // function renderHistory(items, q) {
    //   const box = $('history');
    //   box.innerHTML = '';
    //   const query = (q||'').trim();
    //   let re = null;
    //   if (query) {
    //     const parts = query.split(/\s+/).filter(Boolean).map(escRe);
    //     if (parts.length) re = new RegExp('(' + parts.join('|') + ')', 'ig');
    //   }
    //   for (const it of items) {
    //     const row = document.createElement('div');
    //     row.className = 'history-item';
    //     const ts = document.createElement('div'); ts.className = 'ts muted'; ts.textContent = it.ts + (it.level ? ` · ${it.level}` : '');
    //     const ct = document.createElement('div');
    //     if (re) {
    //       const segs = it.content.split(re);
    //       for (let i=0;i<segs.length;i++) {
    //         if (i%2===1) { const m=document.createElement('mark'); m.textContent=segs[i]; ct.appendChild(m); }
    //         else { ct.appendChild(document.createTextNode(segs[i])); }
    //       }
    //     } else {
    //       ct.textContent = it.content;
    //     }
    //     row.appendChild(ts); row.appendChild(ct);
    //     box.appendChild(row);
    //   }
    // }

    // The search function is no longer needed as it's not used in the new HTML.
    // async function search(offset=0) {
    //   state.offset = Math.max(0, offset);
    //   const params = new URLSearchParams();
    //   params.set('limit', String(state.limit));
    //   params.set('offset', String(state.offset));
    //   const q = $('q').value.trim(); if (q) params.set('q', q);
    //   const lv = $('levelFilter').value; if (lv) params.set('level', lv);
    //   const tf = $('timeFrom').value.trim(); if (tf) params.set('time_from', tf);
    //   const tt = $('timeTo').value.trim(); if (tt) params.set('time_to', tt);
    //   const res = await fetch('/api/logs?' + params.toString());
    //   const data = await res.json();
    //   state.total = data.total || 0;
    //   $('total').textContent = `共 ${state.total} 条`;
    //   renderHistory(data.items||[], q);
    // }

    // The search button is removed from the new HTML, so this line is no longer needed.
    // $('search').onclick = () => search(0);
    // The prev button is removed from the new HTML, so this line is no longer needed.
    // $('prev').onclick = () => { const off = state.offset - state.limit; if (off >= 0) search(off); };
    // The next button is removed from the new HTML, so this line is no longer needed.
    // $('next').onclick = () => { const off = state.offset + state.limit; if (off < state.total) search(off); };
    // The q input is removed from the new HTML, so this line is no longer needed.
    // $('q').addEventListener('keydown', (e)=>{ if (e.key==='Enter') search(0); });

    // The saveSecret button is removed from the new HTML, so this line is no longer needed.
    // $('saveSecret').onclick = async () => {
    //   const secret = $('controlSecret').value.trim();
    //   if (secret.length < 6) { alert('口令至少6位'); return; }
    //   const res = await fetch('/api/device/secret', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ secret }) });
    //   if (!res.ok) { const err = await res.json().catch(()=>({error:'未知错误'})); alert('保存失败：' + (err.error||res.status)); return; }
    //   alert('已保存');
    // };

    // The sendCmd button is removed from the new HTML, so this line is no longer needed.
    // $('sendCmd').onclick = async () => {
    //   const token = $('controlSecret').value.trim();
    //   const data = $('cmd').value;
    //   if (!state.device_code) { alert('设备码未知'); return; }
    //   if (!token) { alert('请先填写控制口令'); return; }
    //   if (!data) { alert('请输入命令内容'); return; }
    //   const res = await fetch('/api/control/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ device_code: state.device_code, token, data, append_newline: $('appendNl').checked }) });
    //   if (!res.ok) { const err = await res.json().catch(()=>({error:'未知错误'})); alert('发送失败：' + (err.error||res.status)); return; }
    //   $('cmd').value = '';
    // };

    // The loadDevice function is now called directly.
    loadDevice();
    loadConfig();
    $('saveSecret').onclick = setControlSecret;
    $('controlSecret').onkeypress = (e) => {
      if (e.key === 'Enter') {
        setControlSecret();
      }
    };
  </script>
</body>
</html> 