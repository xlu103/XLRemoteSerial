<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XLRemoteSerial - Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <style>
    :root { --card:#f6f8fa; }
    .dark { --card:#111827; }
    .log-line { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">
  <header class="bg-white/60 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex gap-3 items-center flex-wrap">
    <h1 class="text-base font-semibold">远程串口查看器</h1>
    <div class="flex items-center gap-2">
      <input id="code" placeholder="输入8位设备码" class="px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700 w-48 text-center font-mono text-lg tracking-wider" maxlength="8" />
      <button id="connect" class="px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-500 text-white font-medium">连接设备</button>
    </div>
    <div class="flex items-center gap-2">
      <a href="/" class="px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">返回首页</a>
      <button id="toggleTheme" class="px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">🌙</button>
    </div>
    <span id="status" class="px-3 py-2 rounded-md bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">未连接</span>
  </header>
  <div class="p-4 grid gap-3">
    <div class="flex gap-2 items-center">
      <input id="q" placeholder="关键字（空格分词）" class="px-2 py-1 rounded-md border border-slate-300 dark:border-slate-700 min-w-[220px] w-2/5" />
      <button id="search" class="px-3 py-1.5 rounded-md border border-slate-300 dark:border-slate-700">搜索历史</button>
      <span id="total" class="text-slate-500">共 0 条</span>
    </div>

    <div class="rounded-md border border-slate-200 dark:border-slate-800 p-3">
      <div class="flex flex-wrap gap-3 items-center">
        <strong>控制台</strong>
        <input id="token" placeholder="控制口令" class="px-2 py-1 rounded-md border border-slate-300 dark:border-slate-700 w-64" />
        <label class="text-sm text-slate-600 dark:text-slate-300"><input type="checkbox" id="appendNl" checked class="mr-1" /> 追加换行</label>
        <button id="saveToken" class="px-3 py-1.5 rounded-md border border-slate-300 dark:border-slate-700">保存口令</button>
      </div>
      <div class="mt-2">
        <textarea id="cmd" placeholder="输入要发送的命令" class="w-full min-h-[80px] rounded-md border border-slate-300 dark:border-slate-700 p-2"></textarea>
      </div>
      <div class="mt-2 flex justify-between items-center">
        <div class="text-slate-500 text-sm">提示：需要先在设备侧设置控制口令。</div>
        <div>
          <button id="sendCmd" class="px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-500 text-white">发送</button>
        </div>
      </div>
    </div>

    <div id="logs" class="h-[calc(100vh-240px)] overflow-auto rounded-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-3 font-mono text-sm"></div>
  </div>
  <script>
    const $ = (id) => document.getElementById(id);
    const state = { ws: null, code: '', paused: false, autoScroll: true };

    function applyTheme() {
      const isDark = localStorage.getItem('theme') === 'dark';
      document.body.classList.toggle('dark', isDark);
    }
    applyTheme();

    function loadSavedToken() {
      const t = localStorage.getItem('viewer_token') || '';
      if (t) $('token').value = t;
    }

    function connectWS(code) {
      try { if (state.ws) state.ws.close(); } catch {}
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${proto}://${location.host}/ws/view/${encodeURIComponent(code)}`);
      state.ws = ws; state.code = code;
      
      updateStatus('连接中...', 'connecting');
      
      ws.onopen = () => {
        updateStatus('已连接', 'connected');
        appendLine(`[系统] 已连接到设备 ${code}`);
      };
      
      ws.onclose = () => {
        updateStatus('未连接', 'disconnected');
        appendLine('[系统] 连接已断开');
      };
      
      ws.onerror = () => {
        updateStatus('连接错误', 'error');
        appendLine('[系统] 连接发生错误');
      };
      
      ws.onmessage = (ev) => { appendLine(ev.data); };
      setInterval(() => { try { ws.readyState === 1 && ws.send('ping'); } catch {} }, 15000);
    }

    function updateStatus(text, type) {
      const status = $('status');
      status.textContent = text;
      status.className = `px-3 py-2 rounded-md font-medium `;
      
      switch(type) {
        case 'connecting':
          status.className += 'bg-yellow-100 dark:bg-yellow-800 text-yellow-700 dark:text-yellow-300';
          break;
        case 'connected':
          status.className += 'bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-300';
          break;
        case 'disconnected':
          status.className += 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300';
          break;
        case 'error':
          status.className += 'bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-300';
          break;
      }
    }

    function appendLine(text) {
      const el = document.createElement('div');
      el.className = 'log-line';
      el.textContent = text;
      $('logs').appendChild(el);
      if (state.autoScroll) $('logs').scrollTop = $('logs').scrollHeight;
    }

    // 设备码输入验证和自动连接
    $('code').oninput = (e) => {
      const code = e.target.value.trim().toUpperCase();
      e.target.value = code;
      
      // 自动连接（当输入8位设备码时）
      if (code.length === 8) {
        setTimeout(() => connectWS(code), 500);
      }
    };

    $('connect').onclick = () => {
      const code = $('code').value.trim();
      if (!code) { 
        alert('请输入设备码'); 
        $('code').focus();
        return; 
      }
      if (code.length !== 8) {
        alert('设备码必须是8位字符');
        $('code').focus();
        return;
      }
      connectWS(code);
    };

    $('toggleTheme').onclick = () => {
      const isDark = localStorage.getItem('theme') === 'dark';
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      applyTheme();
    };

    $('search').onclick = async () => {
      const code = state.code || $('code').value.trim();
      if (!code) { alert('请输入设备码'); return; }
      const q = $('q').value.trim();
      const params = new URLSearchParams();
      params.set('limit', '200');
      params.set('offset', '0');
      params.set('device_code', code);
      if (q) params.set('q', q);
      const res = await fetch('/api/logs?' + params.toString());
      const data = await res.json();
      $('total').textContent = `共 ${data.total||0} 条`;
      $('logs').innerHTML = '';
      for (const it of (data.items || [])) {
        appendLine(it.ts + ' ' + it.content);
      }
    };

    $('saveToken').onclick = () => {
      const t = $('token').value.trim();
      localStorage.setItem('viewer_token', t);
      alert('已保存');
    };

    $('sendCmd').onclick = async () => {
      const code = state.code || $('code').value.trim();
      if (!code) { alert('请先连接设备'); return; }
      const token = $('token').value.trim();
      const data = $('cmd').value;
      if (!token) { alert('请填写控制口令'); return; }
      if (!data) { alert('请输入命令内容'); return; }
      const res = await fetch('/api/control/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_code: code, token, data, append_newline: $('appendNl').checked })
      });
      if (!res.ok) { const err = await res.json().catch(()=>({error:'未知错误'})); alert('发送失败：' + (err.error||res.status)); return; }
      $('cmd').value = '';
    };

    loadSavedToken();
  </script>
</body>
</html> 