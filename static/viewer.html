<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XLRemoteSerial - Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <style>
    :root { --card:#f6f8fa; }
    .dark { --card:#111827; }
    .log-line { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">
  <header class="bg-white/60 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex gap-3 items-center flex-wrap">
    <h1 class="text-base font-semibold">è¿œç¨‹ä¸²å£æŸ¥çœ‹å™¨</h1>
    <div class="flex items-center gap-2">
      <input id="code" placeholder="è¾“å…¥8ä½è®¾å¤‡ç " class="px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700 w-48 text-center font-mono text-lg tracking-wider" maxlength="8" />
      <button id="connect" class="px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-500 text-white font-medium">è¿æ¥è®¾å¤‡</button>
    </div>
    <div class="flex items-center gap-2">
      <a href="/" class="px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">è¿”å›é¦–é¡µ</a>
      <button id="toggleTheme" class="px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">ğŸŒ™</button>
    </div>
    <span id="status" class="px-3 py-2 rounded-md bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">æœªè¿æ¥</span>
  </header>
  <div class="p-4 grid gap-3">
    <div class="flex gap-2 items-center">
      <input id="q" placeholder="å…³é”®å­—ï¼ˆç©ºæ ¼åˆ†è¯ï¼‰" class="px-2 py-1 rounded-md border border-slate-300 dark:border-slate-700 min-w-[220px] w-2/5" />
      <button id="search" class="px-3 py-1.5 rounded-md border border-slate-300 dark:border-slate-700">æœç´¢å†å²</button>
      <span id="total" class="text-slate-500">å…± 0 æ¡</span>
    </div>

    <div class="rounded-md border border-slate-200 dark:border-slate-800 p-3">
      <div class="flex flex-wrap gap-3 items-center">
        <strong>æ§åˆ¶å°</strong>
        <input id="token" placeholder="æ§åˆ¶å£ä»¤" class="px-2 py-1 rounded-md border border-slate-300 dark:border-slate-700 w-64" />
        <label class="text-sm text-slate-600 dark:text-slate-300"><input type="checkbox" id="appendNl" checked class="mr-1" /> è¿½åŠ æ¢è¡Œ</label>
        <button id="saveToken" class="px-3 py-1.5 rounded-md border border-slate-300 dark:border-slate-700">ä¿å­˜å£ä»¤</button>
      </div>
      <div class="mt-2">
        <textarea id="cmd" placeholder="è¾“å…¥è¦å‘é€çš„å‘½ä»¤" class="w-full min-h-[80px] rounded-md border border-slate-300 dark:border-slate-700 p-2"></textarea>
      </div>
      <div class="mt-2 flex justify-between items-center">
        <div class="text-slate-500 text-sm">æç¤ºï¼šéœ€è¦å…ˆåœ¨è®¾å¤‡ä¾§è®¾ç½®æ§åˆ¶å£ä»¤ã€‚</div>
        <div>
          <button id="sendCmd" class="px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-500 text-white">å‘é€</button>
        </div>
      </div>
    </div>

    <div id="logs" class="h-[calc(100vh-240px)] overflow-auto rounded-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-3 font-mono text-sm"></div>
  </div>
  <script>
    const $ = (id) => document.getElementById(id);
    const state = { ws: null, code: '', paused: false, autoScroll: true };

    function applyTheme() {
      const isDark = localStorage.getItem('theme') === 'dark';
      document.body.classList.toggle('dark', isDark);
    }
    applyTheme();

    function loadSavedToken() {
      const t = localStorage.getItem('viewer_token') || '';
      if (t) $('token').value = t;
    }

    function connectWS(code) {
      try { if (state.ws) state.ws.close(); } catch {}
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${proto}://${location.host}/ws/view/${encodeURIComponent(code)}`);
      state.ws = ws; state.code = code;
      
      updateStatus('è¿æ¥ä¸­...', 'connecting');
      
      ws.onopen = () => {
        updateStatus('å·²è¿æ¥', 'connected');
        appendLine(`[ç³»ç»Ÿ] å·²è¿æ¥åˆ°è®¾å¤‡ ${code}`);
      };
      
      ws.onclose = () => {
        updateStatus('æœªè¿æ¥', 'disconnected');
        appendLine('[ç³»ç»Ÿ] è¿æ¥å·²æ–­å¼€');
      };
      
      ws.onerror = () => {
        updateStatus('è¿æ¥é”™è¯¯', 'error');
        appendLine('[ç³»ç»Ÿ] è¿æ¥å‘ç”Ÿé”™è¯¯');
      };
      
      ws.onmessage = (ev) => { appendLine(ev.data); };
      setInterval(() => { try { ws.readyState === 1 && ws.send('ping'); } catch {} }, 15000);
    }

    function updateStatus(text, type) {
      const status = $('status');
      status.textContent = text;
      status.className = `px-3 py-2 rounded-md font-medium `;
      
      switch(type) {
        case 'connecting':
          status.className += 'bg-yellow-100 dark:bg-yellow-800 text-yellow-700 dark:text-yellow-300';
          break;
        case 'connected':
          status.className += 'bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-300';
          break;
        case 'disconnected':
          status.className += 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300';
          break;
        case 'error':
          status.className += 'bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-300';
          break;
      }
    }

    function appendLine(text) {
      const el = document.createElement('div');
      el.className = 'log-line';
      el.textContent = text;
      $('logs').appendChild(el);
      if (state.autoScroll) $('logs').scrollTop = $('logs').scrollHeight;
    }

    // è®¾å¤‡ç è¾“å…¥éªŒè¯å’Œè‡ªåŠ¨è¿æ¥
    $('code').oninput = (e) => {
      const code = e.target.value.trim().toUpperCase();
      e.target.value = code;
      
      // è‡ªåŠ¨è¿æ¥ï¼ˆå½“è¾“å…¥8ä½è®¾å¤‡ç æ—¶ï¼‰
      if (code.length === 8) {
        setTimeout(() => connectWS(code), 500);
      }
    };

    $('connect').onclick = () => {
      const code = $('code').value.trim();
      if (!code) { 
        alert('è¯·è¾“å…¥è®¾å¤‡ç '); 
        $('code').focus();
        return; 
      }
      if (code.length !== 8) {
        alert('è®¾å¤‡ç å¿…é¡»æ˜¯8ä½å­—ç¬¦');
        $('code').focus();
        return;
      }
      connectWS(code);
    };

    $('toggleTheme').onclick = () => {
      const isDark = localStorage.getItem('theme') === 'dark';
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      applyTheme();
    };

    $('search').onclick = async () => {
      const code = state.code || $('code').value.trim();
      if (!code) { alert('è¯·è¾“å…¥è®¾å¤‡ç '); return; }
      const q = $('q').value.trim();
      const params = new URLSearchParams();
      params.set('limit', '200');
      params.set('offset', '0');
      params.set('device_code', code);
      if (q) params.set('q', q);
      const res = await fetch('/api/logs?' + params.toString());
      const data = await res.json();
      $('total').textContent = `å…± ${data.total||0} æ¡`;
      $('logs').innerHTML = '';
      for (const it of (data.items || [])) {
        appendLine(it.ts + ' ' + it.content);
      }
    };

    $('saveToken').onclick = () => {
      const t = $('token').value.trim();
      localStorage.setItem('viewer_token', t);
      alert('å·²ä¿å­˜');
    };

    $('sendCmd').onclick = async () => {
      const code = state.code || $('code').value.trim();
      if (!code) { alert('è¯·å…ˆè¿æ¥è®¾å¤‡'); return; }
      const token = $('token').value.trim();
      const data = $('cmd').value;
      if (!token) { alert('è¯·å¡«å†™æ§åˆ¶å£ä»¤'); return; }
      if (!data) { alert('è¯·è¾“å…¥å‘½ä»¤å†…å®¹'); return; }
      const res = await fetch('/api/control/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_code: code, token, data, append_newline: $('appendNl').checked })
      });
      if (!res.ok) { const err = await res.json().catch(()=>({error:'æœªçŸ¥é”™è¯¯'})); alert('å‘é€å¤±è´¥ï¼š' + (err.error||res.status)); return; }
      $('cmd').value = '';
    };

    loadSavedToken();
  </script>
</body>
</html> 